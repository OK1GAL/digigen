#include "header.h"

uint16_t current_HELL_bittime_us = DEFAULT_HELL_BIT_TIME;
uint8_t current_HELL_speed = DEFAULT_HELL_SPEED;
//hell font https://bruxy.regnet.cz/hamradio/hell/Rudolf_Hanus-Dalnopisna_technika_systemu_HELL-Priloha.pdf
#define HELL_letters_total 59
uint64_t HELL_letters[] = {
    0b0000000000000000000000000000000000000000000000000, // (space)
    0b0000000000000000000000000000000000000000000000000, // !
    0b0000000000000000000000000000000000000000000000000, // "
    0b0000000000000000000000000000000000000000000000000, // #
    0b0000000000000000000000000000000000000000000000000, // dolar
    0b0000000000000000000000000000000000000000000000000, // %
    0b0000000000000000000000000000000000000000000000000, // &
    0b0000000000001000001100000000000000000000000000000, // '
    0b0000000000000000000000011100011011001000100000000, // (
    0b0000000010001001101100011100000000000000000000000, // )
    0b0000000000000000000000000000000000000000000000000, // *
    0b0000000000100000010000011100000100000010000000000, // +
    0b0000000111000000000000000000000000000000000000000, // ,
    0b0000000000100000010000001000000100000010000000000, // -
    0b0000000010000001000000000000000000000000000000000, // .
    0b0000000010000000100000001000000010000000100000000, // /
    0b0000000001110001000100100010010001000111000000000, // 0
    0b0000000000000000001000000110011111000000000000000, // 1
    0b0000000010011001110100101010010111001000000000000, // 2
    0b0000000000000011000101101010010111001110000000000, // 3
    0b0000000001111000110000011000011110000110000000000, // 4
    0b0000000010000001000000101110010101001110100000000, // 5
    0b0000000011111001010100101010010100001110000000000, // 6
    0b0000000110001001100100011010000111000000100000000, // 7
    0b0000000011011011010110101010110101101101100000000, // 8
    0b0000000000111011010101101010010001001111100000000, // 9
    0b0000000000000000101000010100000000000000000000000, // :
    0b0000000000000000101100010110000000000000000000000, // ;
    0b0000000000000000000000000000000000000000000000000, // <
    0b0000000001010000101000010100001010000101000000000, // =
    0b0000000000000000000000000000000000000000000000000, // >
    0b0000000000011000000101011010000111000000000000000, // ?
    0b0000000000000000000000000000000000000000000000000, // @
    0b0000000011111000101100010010001011001111100000000, // A
    0b0000000010001001111100101010010101001101100000000, // B
    0b0000000011111001000100100010010001001000100000000, // C
    0b0000000010001001111100100010010001001111100000000, // D
    0b0000000011111001010100101010010001001000100000000, // E
    0b0000000011111000010100001010000001000000100000000, // F
    0b0000000011111001000100100010010101001110100000000, // G
    0b0000000011111000010000001000000100001111100000000, // H
    0b0000000000000000000000111110000000000000000000000, // I
    0b0000000011000001000000100000010000001111100000000, // J
    0b0000000011111000010000011100011011001000100000000, // K
    0b0000000011111001000001000000100000010000000000000, // L
    0b0000000011111000001100000100000011001111100000000, // M
    0b0000000011111000011000001000011000001111100000000, // N
    0b0000000011111001000100100010010001001111100000000, // O
    0b0000000000001001111100001010000101000011100000000, // P
    0b0000000011111001000100110010011111011000000000000, // Q
    0b0000000011111000010100001010001101001011000000000, // R
    0b0000000010110001010100101010010101001101000000000, // S
    0b0000000000001000000100111110000001000000100000000, // T
    0b0000000011111001000000100000010000001111100000000, // U
    0b0000000011111001100000011000000110000001100000000, // V
    0b0000000011111001000000111000010000001111100000000, // W
    0b0000000011011000101000011100001010001101100000000, // X
    0b0000000000011000011000111000000110000001100000000, // Y
    0b0000000011001001101001010100101110010011000000000  // Z
};

void set_HELL_mode()
{
    set_HELL_speed(current_HELL_speed);
    set_freq(current_center_freq, SI5351_CLK0);
    tx_enable(0);
}

void refresh_HELL_config()
{
    set_HELL_speed(current_HELL_speed);
    set_freq(current_center_freq, SI5351_CLK0);
}

//sets speed in Bd
void set_HELL_speed(uint16_t speed)
{
    current_HELL_speed = speed;
    current_HELL_bittime_us = ((float)1000000 / (float)current_HELL_speed);
}


void HELL_TX_letter(uint8_t charin)
{
    if (charin >= 97 && charin <= 122)
    {
        charin = charin - 32;
    }
    charin = charin - 32;
    if (charin > HELL_letters_total)
    {
        charin = 31; //? if out of range
    }

    uint64_t charin64 = HELL_letters[charin];

    for (int i = 48; i >= 0; i--)
    {
        tx_enable((charin64 >> i) & 0b1);
        gpio_put(MARK_LED_PIN,(charin64 >> i) & 0b1);
        gpio_put(SPACE_LED_PIN,(charin64 >> i) & 0b1);
        gpio_put(TTY_TX_PIN,(charin64 >> i) & 0b1);
        busy_wait_us(current_HELL_bittime_us);
    }
    tx_enable(0);
}